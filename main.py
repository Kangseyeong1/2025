# streamlit run main.py ë¡œ ì‹¤í–‰í•˜ì„¸ìš”
# -*- coding: utf-8 -*-
import streamlit as st
import math
import re
from collections import defaultdict

# =====================================
# í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • + CSS í…Œë§ˆ
# =====================================
st.set_page_config(page_title="í™”í•™ì‹ ì •ë³´ ì‚¬ì „", page_icon="ğŸ§ª", layout="wide")

# CSS ìŠ¤íƒ€ì¼ ì¶”ê°€
st.markdown("""
    <style>
    body {
        background-color: #f4f9fd;
    }
    .main-title {
        font-size: 2.2em;
        font-weight: bold;
        color: #005f73;
        text-align: center;
        margin-bottom: 20px;
    }
    .sub-title {
        font-size: 1.3em;
        color: #0a9396;
        margin-top: 25px;
        margin-bottom: 10px;
        font-weight: bold;
    }
    .compound-box {
        background: #e9f5f7;
        padding: 18px;
        border-radius: 12px;
        border: 1px solid #94d2bd;
        margin-bottom: 15px;
    }
    .stTable {
        background: white;
        border-radius: 8px;
        padding: 8px;
    }
    .search-box {
        background: white;
        border: 2px solid #0a9396;
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    </style>
""", unsafe_allow_html=True)

# =====================================
# í—¤ë”
# =====================================
st.markdown('<div class="main-title">ğŸ§ª í™”í•™ì‹ ì •ë³´ ì‚¬ì „ (ê³ ë“±í•™ìƒìš©)</div>', unsafe_allow_html=True)
st.write("ğŸ‘‰ H2O, CO2, NaCl ê°™ì€ í™”í•™ì‹ì´ë‚˜ 'ë¬¼', 'ì´ì‚°í™”íƒ„ì†Œ', 'ì†Œê¸ˆ' ê°™ì€ í•œê¸€ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

# =====================================
# ì›ìëŸ‰ ë°ì´í„°
# =====================================
ATOMIC_DATA = {
    'H': (1.008, 'ìˆ˜ì†Œ'), 'C': (12.011, 'íƒ„ì†Œ'), 'N': (14.007, 'ì§ˆì†Œ'), 'O': (15.999, 'ì‚°ì†Œ'),
    'Na': (22.990, 'ë‚˜íŠ¸ë¥¨'), 'Mg': (24.305, 'ë§ˆê·¸ë„¤ìŠ˜'), 'Al': (26.982, 'ì•Œë£¨ë¯¸ëŠ„'), 'Si': (28.085, 'ê·œì†Œ'), 'P': (30.974, 'ì¸'),
    'S': (32.06, 'í™©'), 'Cl': (35.45, 'ì—¼ì†Œ'), 'K': (39.098, 'ì¹¼ë¥¨'), 'Ca': (40.078, 'ì¹¼ìŠ˜'), 'Fe': (55.845, 'ì² '),
    'Cu': (63.546, 'êµ¬ë¦¬'), 'Zn': (65.38, 'ì•„ì—°')
}

TOKEN = re.compile(r"([A-Z][a-z]?|\(|\)|\d+)")

def parse_formula(formula: str):
    tokens = TOKEN.findall(formula.replace(' ', ''))
    stack = [defaultdict(int)]
    i = 0
    def add(sym, n):
        stack[-1][sym] += n
    while i < len(tokens):
        t = tokens[i]
        if t == '(':
            stack.append(defaultdict(int)); i += 1
        elif t == ')':
            i += 1; mult = 1
            if i < len(tokens) and tokens[i].isdigit():
                mult = int(tokens[i]); i += 1
            group = stack.pop()
            for k, v in group.items(): add(k, v * mult)
        elif t.isdigit():
            raise ValueError("ìˆ«ìê°€ ì•ì— ì˜¤ëŠ” í‘œê¸°ëŠ” ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        else:
            sym = t; i += 1
            mult = 1
            if i < len(tokens) and tokens[i].isdigit():
                mult = int(tokens[i]); i += 1
            add(sym, mult)
    if len(stack) != 1: raise ValueError("ê´„í˜¸ ì²˜ë¦¬ ì˜¤ë¥˜")
    return dict(stack[0])

# =====================================
# í™”í•©ë¬¼ ë°ì´í„°
# =====================================
COMPOUNDS = {
    "H2O": {"ì´ë¦„": "ë¬¼", "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´", "ì¢…ë¥˜": "ì‚°í™”ë¬¼", "ì„¤ëª…": "ìƒëª…ì²´ì— í•„ìˆ˜ì ì¸ ê·¹ì„± ìš©ë§¤.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  100â„ƒ, ì–´ëŠ”ì  0â„ƒ", "ì•ˆì „": "ì¼ë°˜ì ìœ¼ë¡œ ì•ˆì „."},
    "CO2": {"ì´ë¦„": "ì´ì‚°í™”íƒ„ì†Œ", "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´", "ì¢…ë¥˜": "ì‚°í™”ë¬¼", "ì„¤ëª…": "í˜¸í¡ê³¼ ì—°ì†Œì˜ ì‚°ë¬¼.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“œë¼ì´ì•„ì´ìŠ¤ -78.5â„ƒ ìŠ¹í™”", "ì•ˆì „": "ê³ ë†ë„ëŠ” ì§ˆì‹ ìœ„í—˜."},
    "NaCl": {"ì´ë¦„": "ì—¼í™”ë‚˜íŠ¸ë¥¨(ì†Œê¸ˆ)", "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´", "ì¢…ë¥˜": "ì´ì˜¨ê²°í•© í™”í•©ë¬¼", "ì„¤ëª…": "ìŒì‹ ì¡°ë¦¬ì— ì‚¬ìš©.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë…¹ëŠ”ì  801â„ƒ", "ì•ˆì „": "ê³¼ë‹¤ ì„­ì·¨ ì‹œ ìœ„í—˜."},
    "NH3": {"ì´ë¦„": "ì•”ëª¨ë‹ˆì•„", "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´", "ì¢…ë¥˜": "ì—¼ê¸°ì„± í™”í•©ë¬¼", "ì„¤ëª…": "ë¹„ë£Œ ì œì¡°ì— ì‚¬ìš©.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  -33â„ƒ", "ì•ˆì „": "í˜¸í¡ê¸° ìê·¹ ìœ„í—˜."},
    "CH4": {"ì´ë¦„": "ë©”í…Œì¸", "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´", "ì¢…ë¥˜": "íƒ„í™”ìˆ˜ì†Œ", "ì„¤ëª…": "ì²œì—°ê°€ìŠ¤ì˜ ì£¼ì„±ë¶„.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  -161â„ƒ", "ì•ˆì „": "ê°€ì—°ì„± ë†’ìŒ."},
    "C2H5OH": {"ì´ë¦„": "ì—íƒ„ì˜¬", "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´", "ì¢…ë¥˜": "ì•Œì½”ì˜¬", "ì„¤ëª…": "ì†Œë…ì œ ë° ìŒë£Œ ì„±ë¶„.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  78â„ƒ", "ì•ˆì „": "ê³¼ìŒì€ ì¤‘ë… ìœ„í—˜."},
    "H2SO4": {"ì´ë¦„": "í™©ì‚°", "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´", "ì¢…ë¥˜": "ì‚°", "ì„¤ëª…": "ê°•ì‚°, ë¹„ë£ŒÂ·í™”í•™ ì‚°ì—…ì— ì‚¬ìš©.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  337â„ƒ", "ì•ˆì „": "ë¶€ì‹ì„± ë§¤ìš° ê°•í•¨."},
    "HCl": {"ì´ë¦„": "ì—¼í™”ìˆ˜ì†Œ(ì—¼ì‚°)", "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´", "ì¢…ë¥˜": "ì‚°", "ì„¤ëª…": "ê°•ì‚°ìœ¼ë¡œ ê¸ˆì†ê³¼ ë°˜ì‘.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ìê·¹ì„± ê¸°ì²´", "ì•ˆì „": "ë¶€ì‹ì„± ê°•í•¨."},
    "CaCO3": {"ì´ë¦„": "íƒ„ì‚°ì¹¼ìŠ˜", "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´", "ì¢…ë¥˜": "ì—¼", "ì„¤ëª…": "ì„íšŒì„, ì¡°ê°œê»ì§ˆ ì„±ë¶„.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë…¹ëŠ”ì  825â„ƒ", "ì•ˆì „": "ì•ˆì „í•¨."},
    "NaHCO3": {"ì´ë¦„": "íƒ„ì‚°ìˆ˜ì†Œë‚˜íŠ¸ë¥¨(ë² ì´í‚¹ì†Œë‹¤)", "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´", "ì¢…ë¥˜": "ì—¼", "ì„¤ëª…": "ì œê³¼, ì„¸ì •ì— ì‚¬ìš©.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "í°ìƒ‰ ë¶„ë§", "ì•ˆì „": "ëŒ€ì²´ë¡œ ì•ˆì „."},
    "H2O2": {"ì´ë¦„": "ê³¼ì‚°í™”ìˆ˜ì†Œ", "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´", "ì¢…ë¥˜": "ì‚°í™”ì œ", "ì„¤ëª…": "ì†Œë…, í‘œë°±ì— ì‚¬ìš©.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  150â„ƒ", "ì•ˆì „": "ê³ ë†ë„ëŠ” í™”ìƒ ìœ„í—˜."},
    "HNO3": {"ì´ë¦„": "ì§ˆì‚°", "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´", "ì¢…ë¥˜": "ì‚°", "ì„¤ëª…": "ë¹„ë£Œ, í­ì•½ ì œì¡°.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  83â„ƒ", "ì•ˆì „": "ë¶€ì‹Â·ì‚°í™”ë ¥ ê°•í•¨."},
    "NaOH": {"ì´ë¦„": "ìˆ˜ì‚°í™”ë‚˜íŠ¸ë¥¨(ê°€ì„±ì†Œë‹¤)", "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´", "ì¢…ë¥˜": "ì—¼ê¸°", "ì„¤ëª…": "ë¹„ëˆ„Â·ì„¸ì œ ì œì¡°.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ì˜ ë…¹ìŒ", "ì•ˆì „": "í”¼ë¶€ í™”ìƒ ìœ ë°œ."},
    "C6H12O6": {"ì´ë¦„": "í¬ë„ë‹¹", "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´", "ì¢…ë¥˜": "íƒ„ìˆ˜í™”ë¬¼", "ì„¤ëª…": "ìƒëª…ì²´ì˜ ì£¼ìš” ì—ë„ˆì§€ì›.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë¬¼ì— ì˜ ë…¹ìŒ", "ì•ˆì „": "ëŒ€ì²´ë¡œ ì•ˆì „."},
    "CH3COOH": {"ì´ë¦„": "ì•„ì„¸íŠ¸ì‚°(ì‹ì´ˆ)", "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´", "ì¢…ë¥˜": "ì‚°(ìœ ê¸°ì‚°)", "ì„¤ëª…": "ì‹ì´ˆ ì„±ë¶„, í™”í•™ ì›ë£Œ.", "ë¬¼ë¦¬ì  ì„±ì§ˆ": "ë“ëŠ”ì  118â„ƒ", "ì•ˆì „": "ê³ ë†ë„ëŠ” ë¶€ì‹ì„±."}
}

NAME_TO_FORMULA = {
    "ë¬¼": "H2O", "ì´ì‚°í™”íƒ„ì†Œ": "CO2", "ì†Œê¸ˆ": "NaCl", "ì—¼í™”ë‚˜íŠ¸ë¥¨": "NaCl",
    "ì•”ëª¨ë‹ˆì•„": "NH3", "ë©”í…Œì¸": "CH4", "ì—íƒ„ì˜¬": "C2H5OH",
    "í™©ì‚°": "H2SO4", "ì—¼ì‚°": "HCl", "íƒ„ì‚°ì¹¼ìŠ˜": "CaCO3", "ì„íšŒì„": "CaCO3",
    "ë² ì´í‚¹ì†Œë‹¤": "NaHCO3", "íƒ„ì‚°ìˆ˜ì†Œë‚˜íŠ¸ë¥¨": "NaHCO3",
    "ê³¼ì‚°í™”ìˆ˜ì†Œ": "H2O2", "ì§ˆì‚°": "HNO3", "ìˆ˜ì‚°í™”ë‚˜íŠ¸ë¥¨": "NaOH", "ê°€ì„±ì†Œë‹¤": "NaOH",
    "í¬ë„ë‹¹": "C6H12O6", "ì•„ì„¸íŠ¸ì‚°": "CH3COOH", "ì‹ì´ˆ": "CH3COOH"
}

# =====================================
# ì§€ì›ë˜ëŠ” í™”í•©ë¬¼ ëª©ë¡
# =====================================
st.markdown('<div class="sub-title">ğŸ“– ê²€ìƒ‰ ê°€ëŠ¥í•œ í™”í•©ë¬¼ ëª©ë¡</div>', unsafe_allow_html=True)
cols = st.columns(2)
half = len(COMPOUNDS) // 2 + len(COMPOUNDS) % 2
for i, (f, info) in enumerate(COMPOUNDS.items()):
    col = cols[0] if i < half else cols[1]
    col.markdown(f"<div class='compound-box'><b>{info['ì´ë¦„']}</b> ({f})</div>", unsafe_allow_html=True)

# =====================================
# ê²€ìƒ‰ ë°•ìŠ¤
# =====================================
st.markdown('<div class="sub-title">ğŸ” í™”í•©ë¬¼ ê²€ìƒ‰</div>', unsafe_allow_html=True)
with st.container():
    st.markdown('<div class="search-box">', unsafe_allow_html=True)
    user_input = st.text_input("í™”í•™ì‹ ë˜ëŠ” í•œê¸€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:")
    st.markdown('</div>', unsafe_allow_html=True)

if user_input:
    formula = NAME_TO_FORMULA.get(user_input, user_input)
    if formula not in COMPOUNDS:
        st.error("âŒ í•´ë‹¹ í™”í•©ë¬¼ì€ ë°ì´í„°ë² ì´ìŠ¤ì— ì—†ìŠµë‹ˆë‹¤.")
    else:
        info = COMPOUNDS[formula]
        st.markdown('<div class="sub-title">ğŸ“Œ ê¸°ë³¸ ì •ë³´</div>', unsafe_allow_html=True)
        st.write(f"**ì´ë¦„**: {info['ì´ë¦„']} ({formula})")
        st.write(f"**ìƒíƒœ(ìƒì˜¨)**: {info['ìƒíƒœ(ìƒì˜¨)']}")
        st.write(f"**ì¢…ë¥˜**: {info['ì¢…ë¥˜']}")
        st.write(f"**ì„¤ëª…**: {info['ì„¤ëª…']}")
        st.write(f"**ë¬¼ë¦¬ì  ì„±ì§ˆ**: {info['ë¬¼ë¦¬ì  ì„±ì§ˆ']}")
        st.write(f"**ì•ˆì „**: {info['ì•ˆì „']}")

        try:
            comp = parse_formula(formula)
            st.markdown('<div class="sub-title">âš› ì›ì†Œ ì¡°ì„± ë° ëª°ì§ˆëŸ‰</div>', unsafe_allow_html=True)
            total_mass = 0; rows = []
            for el, count in comp.items():
                if el in ATOMIC_DATA:
                    mass, kr = ATOMIC_DATA[el]
                    subtotal = mass * count
                    total_mass += subtotal
                    rows.append((f"{el} ({kr})", count, subtotal))
            st.table({"ì›ì†Œ": [r[0] for r in rows], "ê°œìˆ˜": [r[1] for r in rows], "ì§ˆëŸ‰(g/mol)": [r[2] for r in rows]})
            st.success(f"**ì´ ëª°ì§ˆëŸ‰**: {total_mass:.3f} g/mol")
        except Exception as e:
            st.error(f"ì›ì†Œ ë¶„ì„ ì˜¤ë¥˜: {e}")
