# streamlit run app.py ë¡œ ì‹¤í–‰í•˜ì„¸ìš”
# -*- coding: utf-8 -*-
import streamlit as st
import math
import re
from collections import defaultdict

# =====================================
# ê¸°ë³¸ ì„¤ì •
# =====================================
st.set_page_config(page_title="í™”í•™ì‹ ì •ë³´ ì‚¬ì „", page_icon="ğŸ§ª")
st.title("ğŸ§ª í™”í•™ì‹ ì •ë³´ ì‚¬ì „ (ê³ ë“±í•™ìƒìš©)")
st.write("ì˜ˆ: H2O, CO2, NaCl ê°™ì€ í™”í•™ì‹ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ê³ , ëª°ì§ˆëŸ‰ê³¼ êµ¬ì„±ë¹„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.")

# =====================================
# ìµœì†Œ ì›ìëŸ‰ ë°ì´í„° (êµìœ¡ìš© ë°˜ì˜¬ë¦¼)
# í•„ìš”í•œ ì›ì†Œë§Œ ê°„ë‹¨íˆ ìˆ˜ë¡
# =====================================
ATOMIC_MASS = {
    'H': 1.008, 'C': 12.011, 'N': 14.007, 'O': 15.999,
    'Na': 22.990, 'Mg': 24.305, 'Al': 26.982, 'Si': 28.085, 'P': 30.974,
    'S': 32.06, 'Cl': 35.45, 'K': 39.098, 'Ca': 40.078, 'Fe': 55.845,
    'Cu': 63.546, 'Zn': 65.38
}

# =====================================
# ê°„ë‹¨ í™”í•™ì‹ íŒŒì„œ (ê´„í˜¸ ì†Œê·œëª¨ ì§€ì›)
# ì˜ˆ: H2O, CO2, Ca(OH)2
# =====================================
TOKEN = re.compile(r"([A-Z][a-z]?|\(|\)|\d+)")

def parse_formula(formula: str):
    tokens = TOKEN.findall(formula.replace(' ', ''))
    stack = [defaultdict(int)]
    i = 0
    def add(sym, n):
        stack[-1][sym] += n
    while i < len(tokens):
        t = tokens[i]
        if t == '(':
            stack.append(defaultdict(int))
            i += 1
        elif t == ')':
            i += 1
            mult = 1
            if i < len(tokens) and tokens[i].isdigit():
                mult = int(tokens[i]); i += 1
            group = stack.pop()
            for k, v in group.items():
                add(k, v * mult)
        elif t.isdigit():
            # ìˆ«ìê°€ ë¨¼ì € ë‚˜ì˜¤ëŠ” ë³µì¡í•œ ê²½ìš°ëŠ” ê³ ë“±í•™êµ ìˆ˜ì¤€ì—ì„œ ì œì™¸
            # (ì˜ˆ: 5H2O ê°™ì€ í‘œê¸°ëŠ” ì´ ì•±ì—ì„œ ì§€ì›í•˜ì§€ ì•ŠìŒ)
            raise ValueError("ìˆ«ìê°€ ì•ì— ì˜¤ëŠ” í‘œê¸°ëŠ” ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        else:
            # ì›ì†Œ ì‹¬ë³¼
            sym = t; i += 1
            mult = 1
            if i < len(tokens) and tokens[i].isdigit():
                mult = int(tokens[i]); i += 1
            add(sym, mult)
    if len(stack) != 1:
        raise ValueError("ê´„í˜¸ ì²˜ë¦¬ ì˜¤ë¥˜")
    return dict(stack[0])

# =====================================
# ë‚´ì¥ í™”í•©ë¬¼ ì •ë³´ (ê°„ë‹¨ ì„¤ëª…)
# =====================================
COMPOUNDS = {
    "H2O": {
        "ì´ë¦„": "ë¬¼",
        "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´",
        "ì¢…ë¥˜": "ì‚°í™”ë¬¼",
        "ì„¤ëª…": "ê°€ì¥ í”í•œ ìš©ë§¤. ë“ëŠ”ì  100â„ƒ(1atm), ì–´ëŠ”ì  0â„ƒ.",
        "ì•ˆì „": "ì¼ë°˜ì ìœ¼ë¡œ ì•ˆì „í•˜ë‚˜, ì „ê¸°ê¸°ê¸°ì™€ í•¨ê»˜ ì‚¬ìš© ì£¼ì˜."
    },
    "CO2": {
        "ì´ë¦„": "ì´ì‚°í™”íƒ„ì†Œ",
        "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´",
        "ì¢…ë¥˜": "ì‚°í™”ë¬¼",
        "ì„¤ëª…": "í˜¸í¡ì˜ ì‚°ë¬¼, ë“œë¼ì´ì•„ì´ìŠ¤ì˜ ê¸°ì²´. ì‚°ì„± ì‚°í™”ë¬¼.",
        "ì•ˆì „": "ê³ ë†ë„ í¡ì… ì£¼ì˜(ì§ˆì‹ ìœ„í—˜). ë°€íê³µê°„ í™˜ê¸° í•„ìš”."
    },
    "O2": {
        "ì´ë¦„": "ì‚°ì†Œ",
        "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´",
        "ì¢…ë¥˜": "ë‹¨ì›ì†Œ ë¶„ì",
        "ì„¤ëª…": "ì—°ì†Œì™€ í˜¸í¡ì— í•„ìˆ˜.",
        "ì•ˆì „": "ìì²´ëŠ” ê°€ì—°ì„± ì•„ë‹˜. ë‹¤ë§Œ ì—°ì†Œë¥¼ ê°•í•˜ê²Œ ë•ëŠ”ë‹¤."
    },
    "N2": {
        "ì´ë¦„": "ì§ˆì†Œ",
        "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´",
        "ì¢…ë¥˜": "ë‹¨ì›ì†Œ ë¶„ì",
        "ì„¤ëª…": "ê³µê¸°ì˜ ì•½ 78% êµ¬ì„±.",
        "ì•ˆì „": "ê³ ë†ë„ì—ì„œ ì‚°ì†Œ ê²°í• ìœ„í—˜."
    },
    "NaCl": {
        "ì´ë¦„": "ì—¼í™” ë‚˜íŠ¸ë¥¨(ì†Œê¸ˆ)",
        "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´",
        "ì¢…ë¥˜": "ì´ì˜¨ê²°í•©(ì—¼)",
        "ì„¤ëª…": "ë°”ë‹·ë¬¼ì˜ ì£¼ëœ ì—¼. ë¬¼ì— ì˜ ë…¹ìŒ.",
        "ì•ˆì „": "ë³´í†µ ì•ˆì „. ê³¼ë‹¤ì„­ì·¨ ì£¼ì˜."
    },
    "HCl": {
        "ì´ë¦„": "ì—¼í™”ìˆ˜ì†Œ(ì—¼ì‚°)",
        "ìƒíƒœ(ìƒì˜¨)": "ìˆ˜ìš©ì•¡ì€ ê°•ì‚°",
        "ì¢…ë¥˜": "ì‚°",
        "ì„¤ëª…": "ê°•í•œ ì‚°ì„±. ê¸ˆì†ê³¼ ë°˜ì‘í•´ ìˆ˜ì†Œ ë°œìƒ.",
        "ì•ˆì „": "ë¶€ì‹ì„±. í”¼ë¶€/ëˆˆ ë³´í˜¸êµ¬ í•„ìˆ˜."
    },
    "NH3": {
        "ì´ë¦„": "ì•”ëª¨ë‹ˆì•„",
        "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´",
        "ì¢…ë¥˜": "ì—¼ê¸°ì„± ë¶„ì",
        "ì„¤ëª…": "íŠ¹ìœ ì˜ ìê·¹ì„± ëƒ„ìƒˆ. ë¹„ë£Œ ì›ë£Œ.",
        "ì•ˆì „": "ìê·¹ì„±/ë…ì„±. í™˜ê¸°, ë³´í˜¸êµ¬ í•„ìš”."
    },
    "CH4": {
        "ì´ë¦„": "ë©”í…Œì¸(ë©”íƒ„)",
        "ìƒíƒœ(ìƒì˜¨)": "ê¸°ì²´",
        "ì¢…ë¥˜": "íƒ„í™”ìˆ˜ì†Œ",
        "ì„¤ëª…": "ì²œì—°ê°€ìŠ¤ì˜ ì£¼ì„±ë¶„.",
        "ì•ˆì „": "ê°€ì—°ì„±. ëˆ„ì¶œ/ì í™”ì› ì£¼ì˜."
    },
    "C2H5OH": {
        "ì´ë¦„": "ì—íƒ„ì˜¬",
        "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´",
        "ì¢…ë¥˜": "ì•Œì½”ì˜¬",
        "ì„¤ëª…": "ì†Œë…ì œ, ìš©ë§¤, ì—°ë£Œ.",
        "ì•ˆì „": "ì¸í™”ì„±. ë¶ˆê½ƒ/ì—´ì› ì£¼ì˜."
    },
    "H2SO4": {
        "ì´ë¦„": "í™©ì‚°",
        "ìƒíƒœ(ìƒì˜¨)": "ì•¡ì²´",
        "ì¢…ë¥˜": "ê°•ì‚°",
        "ì„¤ëª…": "ê°•í•œ íƒˆìˆ˜ì„±/ì‚°í™”ì„±. ë¹„ë£Œ/ë°°í„°ë¦¬ ì œì¡°.",
        "ì•ˆì „": "ê°•ë¶€ì‹ì„±. ë¬¼ê³¼ í˜¼í•© ì‹œ ë°œì—´(ë°˜ë“œì‹œ ì‚°ì— ë¬¼)."
    },
    "NaHCO3": {
        "ì´ë¦„": "íƒ„ì‚°ìˆ˜ì†Œë‚˜íŠ¸ë¥¨(ë² ì´í‚¹ì†Œë‹¤)",
        "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´",
        "ì¢…ë¥˜": "ì—¼",
        "ì„¤ëª…": "ì•½ì—¼ê¸°ì„±. ì œê³¼, ì²­ì†Œ.",
        "ì•ˆì „": "ë³´í†µ ì•ˆì „. ëˆˆ/í”¼ë¶€ ì ‘ì´‰ ì‹œ ì„¸ì²™."
    },
    "CaCO3": {
        "ì´ë¦„": "íƒ„ì‚°ì¹¼ìŠ˜",
        "ìƒíƒœ(ìƒì˜¨)": "ê³ ì²´",
        "ì¢…ë¥˜": "ì—¼",
        "ì„¤ëª…": "ì„íšŒì„/ì¡°ê°œê»ì§ˆì˜ ì£¼ì„±ë¶„.",
        "ì•ˆì „": "ë¶„ì§„ í¡ì… ì£¼ì˜."
    }
}

# =====================================
# ê³„ì‚° í•¨ìˆ˜
# =====================================

def molar_mass(comp: dict):
    m = 0.0
    for el, n in comp.items():
        if el not in ATOMIC_MASS:
            raise KeyError(f"ì›ìëŸ‰ ë°ì´í„° ì—†ìŒ: {el}")
        m += ATOMIC_MASS[el] * n
    return m

# =====================================
# ì…ë ¥ ì˜ì—­
# =====================================
formula = st.text_input("í™”í•™ì‹ ì…ë ¥", value="H2O", help="ì˜ˆ: H2O, CO2, NaCl, Ca(OH)2")

if formula:
    try:
        comp = parse_formula(formula)
        M = molar_mass(comp)

        # ì´ë¦„/ê¸°ë³¸ì •ë³´ ì°¾ê¸° (ëŒ€ë¬¸ì/ìˆ«ì í˜•íƒœë¡œ í‚¤ ë§ì¶¤)
        key_like = formula.replace(' ', '')
        info = COMPOUNDS.get(key_like)

        st.subheader("ê¸°ë³¸ ì •ë³´")
        if info:
            st.write(f"**ì´ë¦„:** {info['ì´ë¦„']}")
            st.write(f"**ì¢…ë¥˜:** {info['ì¢…ë¥˜']} | **ìƒíƒœ(ìƒì˜¨):** {info['ìƒíƒœ(ìƒì˜¨)']}")
            st.write(f"**ì„¤ëª…:** {info['ì„¤ëª…']}")
            st.write(f"**ì•ˆì „:** {info['ì•ˆì „']}")
        else:
            st.info("ë‚´ì¥ ì‚¬ì „ì— ì—†ëŠ” í™”í•©ë¬¼ì…ë‹ˆë‹¤. ì•„ë˜ ê³„ì‚° ì •ë³´ë§Œ ì œê³µí•©ë‹ˆë‹¤.")

        st.subheader("ì¡°ì„± ë° ëª°ì§ˆëŸ‰")
        col1, col2 = st.columns(2)
        with col1:
            st.markdown("**ì›ì†Œë³„ ê°œìˆ˜**")
            st.table({"ì›ì†Œ": list(comp.keys()), "ê°œìˆ˜": list(comp.values())})
        with col2:
            st.metric("ëª°ì§ˆëŸ‰ (g/mol)", f"{M:.3f}")

        # ì§ˆëŸ‰ ë°±ë¶„ìœ¨
        st.markdown("**ì§ˆëŸ‰ ë°±ë¶„ìœ¨(%)**")
        rows = []
        for el, n in comp.items():
            part = ATOMIC_MASS[el] * n
            pct = part / M * 100
            rows.append((el, round(pct, 3)))
        st.table({"ì›ì†Œ": [r[0] for r in rows], "ì§ˆëŸ‰%": [r[1] for r in rows]})

        # ê°„ë‹¨ ë¶„ë¥˜ íŒíŠ¸ (ê·œì¹™ì„± ë§¤ìš° ë‹¨ìˆœí™”)
        st.subheader("ê°„ë‹¨ ë¶„ë¥˜ íŒíŠ¸")
        els = set(comp.keys())
        if els == {"H", "O"} and comp.get("H",0)==2 and comp.get("O",0)==1:
            st.write("ë¬¼(H2O): ê·¹ì„± ë¶„ì, ìš°ìˆ˜í•œ ìš©ë§¤")
        elif "Na" in els and "Cl" in els and len(els)==2:
            st.write("ì´ì˜¨ê²°í•© ì—¼ìœ¼ë¡œ ë¶„ë¥˜")
        elif "C" in els and "H" in els and len(els) == 2:
            st.write("íƒ„í™”ìˆ˜ì†Œì˜ í•œ ì¢…ë¥˜ì¼ ê°€ëŠ¥ì„±(ì˜ˆ: CH4, C2H6)")
        elif "C" in els and "O" in els and len(els) == 2:
            st.write("íƒ„ì†Œì˜ ì‚°í™”ë¬¼ì¼ ê°€ëŠ¥ì„±(ì˜ˆ: CO, CO2)")
        else:
            st.write("ì¼ë°˜ì  ë¶„ë¥˜ë¥¼ ë‹¨ìˆœ ì¶”ì •í•˜ê¸° ì–´ë ¤ì›€. êµ¬ì„± ì›ì†Œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.")

    except Exception as e:
        st.error(f"í•´ì„/ê³„ì‚° ì˜¤ë¥˜: {e}")

st.divider()
st.caption("â€» êµìœ¡ìš© ê°„ì´ ë„êµ¬ì…ë‹ˆë‹¤. ì •í™•í•œ ìˆ˜ì¹˜/ì•ˆì „ ì •ë³´ëŠ” êµê³¼ì„œì™€ ê³µì¸ ìë£Œë¥¼ í™•ì¸í•˜ì„¸ìš”.")
